(()=>{var e={n:t=>{var s=t&&t.__esModule?()=>t.default:()=>t;return e.d(s,{a:s}),s},d:(t,s)=>{for(var n in s)e.o(s,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:s[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};(()=>{"use strict";e.r(t);const s=flarum.core.compat.app;var n=e.n(s);const o=flarum.core.compat.extend,a=flarum.core.compat["components/IndexPage"];var r=e.n(a);function i(e,t){return i=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},i(e,t)}function c(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,i(e,t)}const u=flarum.core.compat["common/Model"];var l=e.n(u);const h=flarum.core.compat["common/utils/mixin"];var d=e.n(h),p=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t.prototype.apiEndpoint=function(){return"/whisper/messages"+(this.exists?"/"+this.data.id:"")},t}(d()(l(),{message:l().attribute("message"),user:l().hasOne("user"),isHidden:l().attribute("isHidden"),createdAt:l().attribute("createdAt",l().transformDate),conversation:l().hasOne("conversation"),number:l().hasOne("number")})),v=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t.prototype.apiEndpoint=function(){return"/whisper/conversations"+(this.exists?"/"+this.data.id:"")},t}(d()(l(),{messages:l().hasMany("messages"),recipients:l().hasMany("recipients"),totalMessages:l().attribute("totalMessages"),notNew:l().attribute("notNew"),createdAt:l().attribute("createdAt",l().transformDate),updatedAt:l().attribute("updatedAt",l().transformDate)})),f=function(e){function t(){return e.apply(this,arguments)||this}return c(t,e),t}(d()(l(),{conversation:l().hasOne("conversation"),user:l().hasOne("user"),userId:l().attribute("userId"),conversationId:l().attribute("conversationId"),lastRead:l().attribute("lastRead")}));const g=flarum.core.compat["models/User"];var y=e.n(g);const w=flarum.core.compat.Model;var b=e.n(w);const M=flarum.core.compat["common/components/Page"];var N=e.n(M);const C=flarum.core.compat["common/components/Button"];var T=e.n(C);const I=flarum.core.compat["common/Component"];var x=e.n(I);const A=flarum.core.compat["common/helpers/avatar"];var k=e.n(A);const O=flarum.core.compat["common/helpers/username"];var P=e.n(O);const R=flarum.core.compat["common/helpers/humanTime"];var _=e.n(R);const D=flarum.core.compat["common/components/LoadingIndicator"];var L=e.n(D),S=function(e){function t(){return e.apply(this,arguments)||this}c(t,e),t.initAttrs=function(e){e.className=e.className||"",e.content=e.content||"",e.preview=e.preview||!1};var s=t.prototype;return s.view=function(){return m("div",{className:this.attrs.className})},s.oncreate=function(t){var s=this;if(e.prototype.oncreate.call(this,t),this.attrs.preview){var n,o=function(){var e=s.attrs.content;n!==e&&(n=e,s9e.TextFormatter.preview(e||"",t.dom))};o(),this.updateInterval=setInterval(o,50)}else s9e.TextFormatter.preview(this.attrs.content,t.dom)},s.onremove=function(){clearInterval(this.updateInterval)},t}(x());const U=flarum.core.compat["common/utils/Stream"];var H=e.n(U);const j=flarum.core.compat["common/utils/withAttr"];var B=e.n(j);const q=flarum.core.compat["common/helpers/icon"];var E=e.n(q);const z=flarum.core.compat["forum/app"];var F=e.n(z),K=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(e){var t=this;this.loading=!0,this.vnode=e,this.mobile=e.attrs.mobile,this.idParam=m.route.param("id"),this.firstLoad=!0,this.typingTimeout=!0,this.sendTimeout=!0,this.interval3=function(){if(0===t.timer)return t.sendTimeout=!0,void m.redraw();t.timer--,t.timer>=0&&setTimeout((function(){t.interval3()}),1e3)},function e(){t.typingTimeout=!0,setTimeout((function(){e()}),5e3)}(),function e(){t.typingTime<new Date(Date.now()-6e3)&&(t.typing=!1,m.redraw()),setTimeout((function(){e()}),6e3)}(),this.typing=!1,this.conversation=this.conversation?this.conversation:e.attrs.conversation,this.initPost()},s.initPost=function(){return this.newMessageCount=0,this.load(),this.messageContent=H()(""),new Promise((function(){setTimeout((function(){$(".chat-history").animate({scrollTop:$(".chat-history").prop("scrollHeight")},1e3)}),500)}))},s.onremove=function(){F().pusher&&F().pusher.then((function(e){var t=e.channels;t.user.unbind("typing"),t.user.unbind("newMessage")}))},s.onupdate=function(){var e=this;$(".chat-history").scroll((function(){if(!e.notNew&&0===$(".chat-history").scrollTop()){var t=$(".message-content:first");e.getMessages(F().cache.messages[e.conversation.id()].length),e.notNew||$(".chat-history").scrollTop(t.offset().top)}}))},s.onbeforeupdate=function(){var e=this;$(".UserListItem").off("click").on("click",(function(t){e.conversation=F().cache.conversations[$(t.currentTarget).attr("id")],e.index=$(t.currentTarget).attr("id"),e.notNew=!1,e.cipher=null,e.oninit(e.vnode),m.redraw()})),$("#MessageTextArea").off().on("keydown",(function(t){13===t.keyCode&&F().forum.attribute("whisperReturnKey")&&($("#MessageTextArea").prop("disabled",!0),e.sendMessage())}))},s.oncreate=function(){var e=this;F().pusher&&F().pusher.then((function(t){var s=t.channels;s.user.bind("newMessage",(function(t){if(parseInt(t.conversationId)===parseInt(e.conversation.id())&&$(".MessagesDropdown").children(".Dropdown-menu").is(":visible")){var s={id:H()(t.id),message:H()(t.message),user:H()(e.user),createdAt:H()(t.createdAt)};e.decryptMessages([s]),e.newMessageCount++,e.typing=!1,m.redraw(),$(".chat-history").animate({scrollTop:$(".chat-history").prop("scrollHeight")},1e3)}})),s.user.bind("typing",(function(t){if(parseInt(t.conversationId)===parseInt(e.conversation.id())){var s=$(".chat-history"),n=!1;s.scrollTop()+s.innerHeight()>=s[0].scrollHeight-50&&(n=!0),e.typing=!0,e.typingTime=new Date,m.redraw(),n&&s.animate({scrollTop:$(".chat-history").prop("scrollHeight")},400)}})),s.user.bind("readMessage",(function(t){parseInt(t.conversationId)===parseInt(e.conversation.id())&&(e.recipient.lastRead=m.prop(t.number),m.redraw())}))}))},s.view=function(){var e=this;return this.messages=F().cache.messages?F().cache.messages[this.conversation.id()]:[],m("div",{style:this.idParam&&this.mobile?"width: 100%":"",className:"chat"},m("div",{className:"chat-header clearfix"},k()(this.user),m("div",{className:"chat-about"},m("div",{className:"chat-with"},P()(this.user)),m("div",{className:"chat-num-messages"},F().translator.trans("nodeloc-whisper.forum.chat.messages_"+(parseInt(this.conversation.totalMessages())>1?"multiple":"single"),{count:this.conversation.totalMessages()+this.newMessageCount})))),this.messages&&this.messages.length>0&&!this.loading?[m("div",{className:"chat-history"},m("ul",null,this.notNew?m("li",{className:"startConvo"},F().translator.trans("nodeloc-whisper.forum.chat.start_of_conversation")):"",this.messages?this.messages.filter((function(e,t,s){return t===s.findIndex((function(t){return t.message()===e.message()}))})).sort((function(e,t){return e.createdAt()-t.createdAt()})).map((function(t,s){var n=parseInt(t.user().id())===parseInt(F().session.user.id());return m("li",{className:"clearfix message-content"},m("div",{className:"message-data "+(n?"align-right":"")},m("div",{className:"avatar-inline "+(n?"me":"other")},k()(n?F().session.user:t.user())),m("span",{className:"message-data-name"},P()(n?F().session.user:t.user())),m("span",{className:"message-data-time"},_()(t.createdAt()))),m(S,{content:t.message(),className:"message "+(n?"my-message float-right":"other-message")}),n&&parseInt(e.recipient.lastRead())>=parseInt(t.data.attributes.number)?m("span",{className:"message-read"},E()("fas fa-check")):"")})):"",this.messageContent()?m("li",null,m(S,{content:this.messageContent(),className:"message my-message float-right message-preview",preview:!0})):"",this.typing?m("li",null,m("div",{className:"tiblock"},m("div",{className:"tidot"}),m("div",{className:"tidot"}),m("div",{className:"tidot"}))):""))]:m(L(),{display:"block",size:"medium"}),m("form",{className:"chat-message clearfix"},m("textarea",{id:"MessageTextArea",value:this.messageContent(),oninput:B()("value",this.typingPush.bind(this)),placeholder:F().translator.trans("nodeloc-whisper.forum.chat.text_placeholder"),rows:"3"}),T().component({onclick:this.sendMessage.bind(this),className:"Button Button--primary",disabled:!this.messageContent()||!this.sendTimeout},F().translator.trans("nodeloc-whisper.forum.chat.send"))))},s.typingPush=function(e){var t=this;this.messageContent(e),m.redraw(),this.typingTimeout&&F().request({method:"POST",url:F().forum.attribute("apiUrl")+"/whisper/messages/typing",body:{conversationId:this.conversation.id(),userId:this.user.id()}}).then((function(){t.typingTimeout=!1}))},s.sendMessage=function(){var e=this;if(this.sendTimeout){if(""===this.messageContent()||!this.messageContent().replace(/\s/g,"").length)return;this.sendTimeout=!1,this.timer=1,this.interval3(),this.newMessageCount++,F().store.createRecord("messages").save({messageContents:this.messageContent(),conversationId:this.conversation.id()}).then((function(t){F().cache.messages[e.conversation.id()].push(t),m.redraw(),e.messageContent(""),$(".chat-history").animate({scrollTop:$(".chat-history").prop("scrollHeight")},500),F().request({method:"POST",url:F().forum.attribute("apiUrl")+"/whisper/messages/read",body:{conversationId:e.conversation.id(),messageId:t.id()}})}))}},s.getMessages=function(e){var t=this;void 0===e&&(e=0),this.notNew||F().store.find("whisper/messages",this.conversation.id(),{offset:e}).then((function(e){var s;if(delete e.payload,t.firstLoad){var n=t.meRecipient.lastRead();F().request({method:"POST",url:F().forum.attribute("apiUrl")+"/whisper/messages/read",body:{conversationId:t.conversation.id(),messageId:e[0].id()}}).then((function(e){var s=e.data.attributes.lastRead,o=0,a=F().session.user.unreadMessages();0!==a&&(o=a-(s-n)),o>=0&&(F().session.user.pushAttributes({unreadMessages:o}),m.redraw()),t.firstLoad=!1}))}(s=F().cache.messages[t.conversation.id()]).push.apply(s,e),e.length<20&&(t.notNew=!0)})).then((function(){t.loading=!1,m.redraw()}))},s.load=function(){var e=this;this.loading=!0,m.redraw(),F().cache.messages||(F().cache.messages=[]),this.conversation.recipients().map((function(t){parseInt(t.user().id())!==parseInt(F().session.user.id())?(e.user=t.user(),e.recipient=t):e.meRecipient=t})),F().cache.messages[this.conversation.id()]||(F().cache.messages[this.conversation.id()]=[]),this.getMessages()},t}(x());flarum.core.compat["common/helpers/userOnline"];var G=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){var s=this;this.conversation=t.attrs.conversation,this.index=t.attrs.i,this.active=t.attrs.active,this.loading=!0,this.mobile=t.attrs.mobile,this.conversation.recipients().map((function(e){parseInt(e.user().id())!==parseInt(F().session.user.id())&&(s.user=e.user(),s.loading=!1,m.redraw())})),e.prototype.oncreate.call(this,t)},s.onremove=function(t){e.prototype.onremove.call(this,t)},s.oncreate=function(t){e.prototype.oncreate.call(this,t)},s.onclick=function(e){this.clicked=!0,this.attrs.onclick(e),document.querySelectorAll(".UserListItem").forEach((function(t){t!==e.currentTarget&&t.classList.remove("active")}))},s.view=function(e){var t=this;return this.loading||!this.user?null:m("li",{id:this.index,className:this.clicked?"UserListItem active":"UserListItem",onclick:function(e){return t.onclick(e)}},m("div",{className:"UserListItem-content"},k()(this.user)))},t}(x());const J=flarum.core.compat["common/components/Modal"];var Q=e.n(J);const V=flarum.core.compat["common/components/Alert"];var W=e.n(V),X=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),F().cache.conversationsRecipient=null,this.conversations=this.attrs.conversations,this.already=!1,this.messageContent=H()(""),this.conversations||(this.conversations=[])},s.title=function(){return F().translator.trans("nodeloc-whisper.forum.modal.title")},s.className=function(){return"StartConversationModal Modal--medium"},s.content=function(){return[m("div",{className:"Modal-body"},m("div",null,m("div",{class:"helpText"},F().translator.trans("nodeloc-whisper.forum.modal.help_start",{username:P()(this.attrs.user)})),m("div",{className:"AddRecipientModal-form"},m("div",{className:"AddRecipientModal-form-submit"},m("textarea",{value:this.messageContent(),oninput:B()("value",this.messageContent),placeholder:F().translator.trans("nodeloc-whisper.forum.chat.text_placeholder"),rows:"3"}),T().component({type:"submit",className:"Button Button--primary",disabled:!this.messageContent()},F().translator.trans("nodeloc-whisper.forum.modal.submit"))))))]},s.onsubmit=function(e){var t=this;e.preventDefault();var s=this.attrs.user;F().cache.conversationsRecipient=null,F().store.createRecord("conversations").save({messageContents:this.messageContent(),recipient:s.id()}).then((function(e){if(!e.notNew()){t.conversations.push(e);var s=F().session.user.conversations();s&&(s.push(e),F().session.user.conversations=H()(s))}F().alerts.show(W(),{type:"success"},F().translator.trans("nodeloc-whisper.forum.chat.send_success")),m.redraw(),F().modal.close()}))},t}(Q()),Y=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(e){this.mobile=e.attrs.mobile,this.load(),this.loading=!1,this.currentConversation=null},s.onupdate=function(){},s.view=function(){var e=this;if(!this.loading&&F().cache.conversations){var t=F().cache.conversations;return null===this.currentConversation&&F().cache.conversations&&F().cache.conversations.length>0&&(this.currentConversation=F().cache.conversations[0]),this.currentConversation&&(this.conversationComponent=K.component({conversation:this.currentConversation,mobile:this.mobile})),m("div",{className:"ConversationsList"},m("div",{style:t.length?"":"width: unset; padding: 10px;",className:"container clearfix"},m("div",{style:this.mobile?"float: unset; margin: 0 auto; display: block;":"",className:"people-list",id:"people-list"},!!t.length&&m("ul",{className:"ConversationsList-list"},Array.isArray(t)&&t.map((function(t,s){return m(G,{conversation:t,i:s,active:!e.mobile&&e.currentConversation===t,onclick:function(t){e.mobile?m.route(F().route("messages",{id:F().cache.conversations[$(t.currentTarget).attr("id")].id()})):(e.currentConversation=F().cache.conversations[$(t.currentTarget).attr("id")],m.redraw())}})})))),!this.mobile&&this.conversationComponent))}},s.showModal=function(){F().modal.show(X,{conversations:F().cache.conversations,messages:F().cache.messages})},s.loadMore=function(){var e=this;this.loading=!0,m.redraw(),F().store.find("whisper/conversations",{offset:F().cache.conversations.length}).then((function(e){delete e.payload,e.map((function(e){F().cache.conversations.push(e)}))})).catch((function(){})).then((function(){e.loading=!1,m.redraw()}))},s.load=function(){var e=this;F().cache.conversations&&!this.mobile||(this.mobile&&(F().cache.conversations=[]),this.loading=!0,m.redraw(),F().store.find("whisper/conversations").then((function(e){delete e.payload,F().cache.conversations=e})).catch((function(){})).then((function(){e.loading=!1,m.redraw()})))},t}(x()),Z=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(){e.prototype.oninit.call(this),app.history.push("messages"),this.bodyClass="App--conversations"},s.view=function(){return m("div",{className:"ConversationsPage"},m(Y,{mobile:!0}))},t}(N()),ee=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.init=function(){var t=this;e.prototype.init.call(this),app.history.push("conversations");var s=m.route.param("id");app.store.find("whisper/conversations",s).then((function(e){app.cache.conversations=[],app.cache.conversations.push(e),t.list=K.component({conversation:e,mobile:!0}),m.redraw()})),this.bodyClass="App--messages"},s.view=function(){return m("div",{className:"MessagesPage"},m("div",{className:"ConversationsList"},m("div",{className:"container clearfix"},this.list?this.list:null)))},t}(N());const te=flarum.core.compat["utils/Stream"];var se=e.n(te);const ne=flarum.core.compat["utils/UserControls"];var oe=e.n(ne);const ae=flarum.core.compat["components/Button"];var re=e.n(ae);const ie=flarum.core.compat["common/extend"],ce=flarum.core.compat["forum/components/HeaderSecondary"];var ue=e.n(ce);const me=flarum.core.compat["forum/components/NotificationsDropdown"];var le=function(e){function t(){return e.apply(this,arguments)||this}c(t,e);var s=t.prototype;return s.oninit=function(t){e.prototype.oninit.call(this,t),this.onclick=this.onclick.bind(this),this.getMenu=this.getMenu.bind(this),this.goToRoute=this.goToRoute.bind(this)},t.initAttrs=function(t){t.label||(t.label=F().translator.trans("nodeloc-whisper.forum.dropdown.tooltip")),t.icon||(t.icon="fas fa-sms"),t.className="MessagesDropdown NotificationsDropdown",e.initAttrs.call(this,t)},s.onclick=function(){F().drawer.isOpen()&&this.goToRoute()},s.getMenu=function(){return m("form",{className:"Dropdown-menu "+this.attrs.menuClassName},!!this.showing&&m(Y,{mobile:!1}))},s.goToRoute=function(){var e=F().route("conversations");console.error("Conversations route:",F().routes),F().route&&e?m.route(e):console.error("Conversations route not found!")},s.getUnreadCount=function(){return F().session.user.unreadMessages()},s.getNewCount=function(){return F().session.user.unreadMessages()},t}(e.n(me)());n().initializers.add("nodeloc-whisper",(function(e){e.store.models.messages=p,e.store.models.conversations=v,e.store.models.conversation_users=f,y().prototype.conversations=b().hasMany("conversations"),y().prototype.unreadMessages=b().attribute("unreadMessages"),e.routes.conversations={path:"/whisper/conversations",component:Z},e.routes.messages={path:"/whisper/messages/:id",component:ee},(0,ie.extend)(ue().prototype,"items",(function(e){(F().forum.attribute("canMessage")||F().session.user&&F().session.user.conversations().length)&&e.add("Messages",m(le,null),20)})),(0,o.extend)(r().prototype,"oncreate",(function(){e.pusher&&e.pusher.then((function(t){var s=t.channels;s.user&&s.user.bind("newMessage",(function(t){e.session.user.unreadMessages=se()(e.session.user.unreadMessages()+1),m.redraw()}))}))})),(0,o.extend)(r().prototype,"onremove",(function(){e.pusher&&e.pusher.then((function(e){var t=e.channels;t.user&&t.user.unbind("newMessage")}))})),(0,o.extend)(oe(),"moderationControls",(function(t,s){e.forum.attribute("canMessage")&&t.add("newMessage",re().component({icon:"fas fa-sms",onclick:function(){return e.modal.show(X,{user:s})}},e.translator.trans("nodeloc-whisper.forum.chat.chat_with")))}))}))})(),module.exports=t})();
//# sourceMappingURL=forum.js.map